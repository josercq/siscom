<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Processo – SISCOM</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">

    <style>
        .management-header { background-color: #fff; border-bottom: 1px solid #e0e0e0; padding: 30px 0; margin-bottom: 30px; }
        .status-badge { background-color: #e0f2f1; color: #00695c; padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; }
        .summary-card { background: #f8f9fa; border-left: 5px solid #FFC107; padding: 20px; border-radius: 4px; margin-bottom: 30px; }
        .proposals-table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; }
        .proposals-table th { background-color: #1a1a1a; color: #fff; padding: 15px; text-align: left; font-weight: 700; text-transform: uppercase; font-size: 0.9rem; }
        .proposals-table td { padding: 15px; border-bottom: 1px solid #eee; color: #333; vertical-align: middle; }
        .proposals-table tr:hover { background-color: #ffffef; }
        .price-tag { font-weight: 900; font-size: 1.1rem; color: #333; display: block; }
        .btn-action { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: 700; transition: all 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-view { background-color: #e0e0e0; color: #333; margin-right: 5px; }
        .btn-approve { background-color: #1a1a1a; color: #fff; border: 1px solid #1a1a1a; }
        
        /* Estilos Extras */
        .star-rating { color: #ccc; font-size: 0.85rem; }
        .star-rating .filled { color: #FFC107; }
        .rating-score { font-weight: bold; color: #666; font-size: 0.8rem; margin-left: 5px; }

        /* Modal PDF */
        .pdf-modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); z-index: 10000;
            display: none; justify-content: center; align-items: center;
        }
        .pdf-modal-content {
            background: #fff; width: 90%; max-width: 700px; height: 85vh;
            border-radius: 4px; display: flex; flex-direction: column;
        }
        .pdf-header {
            background: #333; color: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center;
        }
        .pdf-body {
            padding: 40px; overflow-y: auto; flex: 1; font-family: 'Courier New', Courier, monospace; background: #fafafa;
        }
        .doc-paper {
            background: #fff; border: 1px solid #ddd; padding: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div id="site-header"></div>
    <main>
        <div class="management-header">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="color: #666; margin-bottom: 5px;">Gerenciamento de Processo</h4>
                        <h1 id="page-opp-title" style="margin: 0; font-size: 1.8rem;">Carregando...</h1>
                    </div>
                    <span class="status-badge">Em Aberto - Recebendo Propostas</span>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="summary-card">
                <h3 style="margin-top: 0; font-size: 1.1rem;"><i class="fas fa-info-circle"></i> Resumo da Solicitação</h3>
                <p id="page-opp-desc" style="margin-bottom: 0; color: #555;">...</p>
            </div>

            <h2 class="section-title" style="text-align: left; margin-bottom: 20px;">Orçamentos Recebidos</h2>
            
            <div class="responsive-table">
                <table class="proposals-table">
                    <thead>
                        <tr>
                            <th>Prestador de Serviço</th>
                            <th>Avaliação (Média)</th>
                            <th>Data Envio</th>
                            <th>Valor Total</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody id="received-proposals-body">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="pdf-modal" class="pdf-modal-overlay">
        <div class="pdf-modal-content">
            <div class="pdf-header">
                <span><i class="fas fa-file-pdf"></i> Visualização do Orçamento</span>
                <button onclick="closePdfModal()" style="background:none; border:none; color:#fff; cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="pdf-body">
                <div class="doc-paper">
                    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
                        <h2 id="pdf-provider">Fornecedor</h2>
                        <small>Orçamento Técnico Oficial</small>
                    </div>
                    <p><strong>Ref:</strong> <span id="pdf-ref-title">...</span></p>
                    <p><strong>Data:</strong> <span id="pdf-date">...</span></p>
                    <hr>
                    <table style="width:100%; margin: 20px 0;">
                        <tr style="background:#eee;">
                            <th style="padding:8px; text-align:left;">Descrição</th>
                            <th style="padding:8px; text-align:right;">Total</th>
                        </tr>
                        <tr>
                            <td style="padding:8px;">Serviços e Materiais conforme solicitado</td>
                            <td style="padding:8px; text-align:right;" id="pdf-value">...</td>
                        </tr>
                    </table>
                    <div style="text-align:right; font-weight:bold; font-size:1.2rem; border-top:2px solid #000; padding-top:10px;">
                        Total: <span id="pdf-total">...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="site-footer"></div>
    <script src="inc/header-footer.js"></script>
    <script src="jsmain.js"></script>

    <script>
        // Função para gerar estrelas aleatórias (mantém a ilusão de BD completo)
        function getFakeRating() {
            const score = (Math.random() * (5.0 - 3.0) + 3.0).toFixed(1);
            let stars = '';
            for(let i=1; i<=5; i++) {
                if(i <= Math.floor(score)) stars += '<i class="fas fa-star filled"></i>';
                else if(i === Math.ceil(score)) stars += '<i class="fas fa-star-half-alt filled"></i>';
                else stars += '<i class="far fa-star filled" style="opacity:0.3"></i>';
            }
            return { html: stars, score: score };
        }

        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            const oppId = params.get('id');

            // 1. Carregar Detalhes da Oportunidade
            const seed = JSON.parse(localStorage.getItem("siscom_data_v9")) || [];
            const custom = JSON.parse(localStorage.getItem("siscom_custom_opps")) || [];
            const allOpps = [...seed, ...custom];
            
            const currentOpp = allOpps.find(o => o.id === oppId);

            if (currentOpp) {
                document.getElementById('page-opp-title').textContent = currentOpp.title;
                document.getElementById('page-opp-desc').innerHTML = `${currentOpp.description} <br><br><strong>Local:</strong> ${currentOpp.location}`;
            } else {
                document.getElementById('page-opp-title').textContent = "Oportunidade não encontrada";
            }

            // 2. Carregar Propostas Recebidas (Do LocalStorage real)
            const allReceived = JSON.parse(localStorage.getItem("siscom_received_proposals")) || {};
            // Tenta pegar pelo ID (novo padrão) ou pelo Título (legado)
            const proposals = allReceived[oppId] || (currentOpp ? allReceived[currentOpp.title] : []) || [];

            const tbody = document.getElementById('received-proposals-body');
            tbody.innerHTML = "";

            if (proposals.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:#777;">Ainda não há orçamentos para esta oportunidade.</td></tr>`;
            } else {
                // Ordenar por preço (converter string "R$ 1.000,00" para float)
                proposals.sort((a, b) => {
                    const pA = parseFloat(a.price.replace(/[^\d,]/g, '').replace(',', '.'));
                    const pB = parseFloat(b.price.replace(/[^\d,]/g, '').replace(',', '.'));
                    return pA - pB;
                });

                proposals.forEach((p, index) => {
                    const rating = getFakeRating();
                    const isBestPrice = index === 0;
                    
                    const tr = document.createElement('tr');
                    if (isBestPrice) tr.style.backgroundColor = "#f0fdf4";

                    tr.innerHTML = `
                        <td>
                            <strong>${p.providerName}</strong> 
                            ${isBestPrice ? '<span style="font-size:0.7rem; background:#10B981; color:#fff; padding:2px 6px; border-radius:4px;">Melhor Preço</span>' : ''}
                            <br><span style="font-size:0.8rem; color:#888;">Resp: ${p.providerUser || 'admin'}</span>
                        </td>
                        <td>
                            <div class="star-rating">
                                ${rating.html} <span class="rating-score">${rating.score}</span>
                            </div>
                        </td>
                        <td>${p.date || 'Hoje'}</td>
                        <td><span class="price-tag">${p.price}</span></td>
                        <td>
                            <button class="btn-action btn-view" onclick="openPdf('${p.providerName}', '${p.price}', '${p.date}')"><i class="fas fa-eye"></i></button>
                            <button class="btn-action btn-approve" onclick="aprovar('${p.providerName}')"><i class="fas fa-check"></i> Aprovar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        });

        // Lógica do Modal
        function openPdf(provider, price, date) {
            const title = document.getElementById('page-opp-title').textContent;
            document.getElementById('pdf-provider').textContent = provider;
            document.getElementById('pdf-ref-title').textContent = title;
            document.getElementById('pdf-date').textContent = date || new Date().toLocaleDateString();
            document.getElementById('pdf-value').textContent = price;
            document.getElementById('pdf-total').textContent = price;
            document.getElementById('pdf-modal').style.display = 'flex';
        }

        function closePdfModal() {
            document.getElementById('pdf-modal').style.display = 'none';
        }

        function aprovar(name) {
            if(confirm(`Deseja adjudicar o serviço para ${name}?`)) {
                alert("Processo aprovado com sucesso!");
                window.location.href = "oportunidades.html";
            }
        }
    </script>
</body>
</html>