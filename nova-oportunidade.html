<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Oportunidade – SISCOM</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <div id="site-header"></div>

    <main>
        <section class="section-padding">
            <div class="container">
                <div class="login-container" style="max-width: 800px; display: block;">
                    
                    <div class="login-box" style="width: 100%;">
                        <h2 style="margin-bottom: 20px;">Criar Nova Oportunidade</h2>
                        
                        <form id="new-opp-form">
                            <div class="form-group">
                                <label>Escola Responsável</label>
                                <input type="text" id="school-name" disabled style="background: #f0f0f0; font-weight: bold;">
                            </div>

                            <div class="form-group">
                                <label for="title">Título da Demanda</label>
                                <input type="text" id="title" placeholder="Ex: Reforma do Telhado, Compra de Papel..." required>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label for="category">Categoria (Ícone)</label>
                                    <select id="category">
                                        <option value="fas fa-pump-soap">Limpeza</option>
                                        <option value="fas fa-tools">Manutenção / Obras</option>
                                        <option value="fas fa-utensils">Alimentação</option>
                                        <option value="fas fa-desktop">Tecnologia</option>
                                        <option value="fas fa-pencil-alt">Material Escolar</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="expiry">Data de Encerramento</label>
                                    <input type="text" id="expiry" placeholder="dd/mm" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="description">Descrição Detalhada</label>
                                <textarea id="description" rows="5" placeholder="Descreva os itens necessários..." required></textarea>
                            </div>

                            <div class="login-actions" style="margin-top: 30px;">
                                <button type="submit" class="btn btn-primary" style="width: 100%;">
                                    <i class="fas fa-plus-circle"></i> Publicar Oportunidade
                                </button>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <script src="inc/header-footer.js"></script>

    <script>
        // 1. Preencher nome da escola automaticamente
        const loggedUser = JSON.parse(sessionStorage.getItem("siscom_user"));
        if (loggedUser && loggedUser.role === 'apm') {
            document.getElementById("school-name").value = loggedUser.name;
        } else {
            alert("Erro: Você precisa estar logado como APM.");
            window.location.href = "login.html";
        }

        // 2. Salvar Nova Oportunidade
        document.getElementById("new-opp-form").addEventListener("submit", (e) => {
            e.preventDefault();

            // Cria o objeto da nova oportunidade

            function generateId(prefix = 'opp') { return prefix + '-' + Math.random().toString(36).slice(2,9); }

            const newOpp = {
                id: generateId('opp'),
                school: loggedUser.name,
                title: document.getElementById("title").value,
                icon: document.getElementById("category").value,
                expiry: document.getElementById("expiry").value,
                description: document.getElementById("description").value,
                status: "aberto",
                location: "Cubatão, SP" // Padrão
            };

            // Pega as existentes ou cria array vazio
            const existingOpps = JSON.parse(localStorage.getItem("siscom_custom_opps")) || [];
            
            // Adiciona a nova
            existingOpps.push(newOpp);

            // Salva de volta
            localStorage.setItem("siscom_custom_opps", JSON.stringify(existingOpps));

            alert("✅ Sucesso!\n\nSua oportunidade foi publicada no painel.");
            window.location.href = "oportunidades.html";
        });
    </script>
</body>
</html>