<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Oportunidades – SISCOM</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .page-header { background-color: #F2D96B; padding: 40px 0; border-bottom: 1px solid #e0c040; width: 100%; }
        .page-header h1 { color: #000; font-weight: 800; margin-bottom: 5px; }
        .page-header p { color: #1a1a1a; font-weight: 600; font-size: 1.1rem; margin: 0; }
        .btn-black { background-color: #000; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 700; cursor: pointer; text-decoration: none; }
        .btn-black:hover { background-color: #333; color: #fff; }
        /* Badge específica para status de envio */
        .badge-status-sent { background-color: #000; color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-bottom: 10px; display: inline-block; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="site-header"></div>

    <main>
        <header class="page-header">
            <div class="container">
                <h1 id="panel-title">Painel de Oportunidades</h1>
                <p>Encontre demandas ou gerencie suas solicitações.</p>
                <div id="apm-controls" style="display: none; margin-top: 20px;">
                    <a href="nova-oportunidade.html" class="btn-black">
                        <i class="fas fa-plus-circle"></i> Nova Oportunidade
                    </a>
                </div>
            </div>
        </header>

        <section class="oportunidades-page section-padding" style="padding-top: 20px;">
            <div class="container">
                
                <div class="filters-bar" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="school-filter">Escola</label>
                        <select id="school-filter" style="width: 100%;">
                            <option value="todas">Todas as Escolas</option>
                            <option value="helena">Profª Helena Duarte</option>
                            <option value="ribeiro">Padre Antônio Ribeiro Filho</option>
                            <option value="saulo">CRECHE Saulo Gomes</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="status-filter">Situação da Proposta</label>
                        <select id="status-filter" style="width: 100%;">
                            <option value="todos">Todos</option>
                            <option value="disponivel">Propostas Disponíveis</option>
                            <option value="enviada">Propostas Enviadas (Minhas)</option>
                            <option value="encerrado">Encerradas</option>
                        </select>
                    </div>
                </div>

                <div id="opportunities-grid" class="opportunities-grid"></div>
                
                <div id="no-results" style="display: none; text-align: center; padding: 40px; grid-column: 1 / -1;">
                    <h3>Nenhuma oportunidade encontrada.</h3>
                </div>

            </div>
        </section>
    </main>

    <div id="site-footer"></div>

    <script src="inc/header-footer.js"></script>
    <script src="jsmain.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // 1. Pega dados do sistema (jsmain.js popula o localStorage inicialmente)
            const allOpps = JSON.parse(localStorage.getItem("siscom_data_v7")) || [];
            const customOpps = JSON.parse(localStorage.getItem("siscom_custom_opps")) || [];
            
            // Junta as fixas com as novas criadas pela APM
            let dataset = [...allOpps, ...customOpps];

            // Pega usuário logado e propostas enviadas
            const user = JSON.parse(sessionStorage.getItem("siscom_user"));
            const storedProposals = JSON.parse(localStorage.getItem("siscom_my_proposals")) || [];
            const myProposals = (user && user.role === 'fornecedor') ? storedProposals.filter(p => p.providerUser === user.user || p.providerName === user.name) : [];


            // Se for APM, mostrar apenas oportunidades da sua escola (comparação normalizada)
            if (user && user.role === 'apm') {
                function normalizeForCompare(s) { return (s||'').toString().trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }
                dataset = dataset.filter(o => normalizeForCompare(o.school) === normalizeForCompare(user.name));
            }

            // Ajuste para APM
            if (user && user.role === 'apm') {
                document.getElementById('apm-controls').style.display = 'block';
                document.getElementById('panel-title').innerText = "Gestão de Oportunidades";
            }

            const grid = document.getElementById('opportunities-grid');
            const schoolFilter = document.getElementById('school-filter');
            const statusFilter = document.getElementById('status-filter');

            function render() {
                grid.innerHTML = "";
                const schoolVal = schoolFilter.value;
                const statusVal = statusFilter.value;
                let hasItem = false;

                dataset.forEach(opp => {
                    // --- LÓGICA DE PROPOSTA ENVIADA ---
                    // Verifica se existe alguma proposta salva para esta opportunityId (quando disponível) ou por título

                    function normalizeKey(s) { return (s||'').toString().trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }
                    const isSent = myProposals.some(p => (p.opportunityId && opp.id) ? p.opportunityId === opp.id : (normalizeKey(p.title) === normalizeKey(opp.title)));

                    // --- FILTROS ---
                    let show = true;

                    // Filtro Escola
                    if (schoolVal !== 'todas') {
                        if (schoolVal === 'helena' && !opp.school.includes('Helena')) show = false;
                        if (schoolVal === 'ribeiro' && !opp.school.includes('Ribeiro')) show = false;
                        if (schoolVal === 'saulo' && !opp.school.includes('Saulo')) show = false;
                    }

                    // Filtro Status (Complexo)
                    if (statusVal === 'enviada') {
                        if (!isSent) show = false;
                    } else if (statusVal === 'disponivel') {
                        // Disponível é: não enviada E não encerrada
                        if (isSent || opp.status === 'encerrado') show = false;
                    } else if (statusVal === 'encerrado') {
                        if (opp.status !== 'encerrado') show = false;
                    }

                    if (show) {
                        hasItem = true;
                        
                        // Define botão e labels
                        let actionBtn = "";
                        let statusBadge = "";
                        let btnClass = "btn-card-action"; // Classe correta do CSS

                        // Lógica de exibição do botão
                        if (user && user.role === 'apm' && user.name === opp.school) {
                            actionBtn = `<a href="gerenciar-oportunidade.html?id=${encodeURIComponent(opp.id || '')}" class="${btnClass}" style="background:#000; color:#fff; border-color:#000;">Gerenciar</a>`;
                        } 
                        else if (isSent) {
                            // SE JÁ ENVIOU
                            statusBadge = `<div class="badge-status-sent"><i class="fas fa-check-circle"></i> Proposta Enviada</div>`;
                            actionBtn = `<button class="${btnClass}" disabled style="background:#e0e0e0; color:#555; border-color:#ccc; cursor: default;">Ver Detalhes</button>`;
                        }
                        else if (opp.status === 'encerrado') {
                            actionBtn = `<button class="${btnClass}" disabled style="opacity:0.6; cursor: not-allowed;">Encerrado</button>`;
                        }
                        else {
                            // Botão padrão de enviar: apenas fornecedores logados podem enviar
                                if (user && user.role === 'fornecedor') {
                                    actionBtn = `<a href="enviar-orcamento.html?school=${encodeURIComponent(opp.school)}&title=${encodeURIComponent(opp.title)}&id=${encodeURIComponent(opp.id || '')}" class="${btnClass}">Enviar Orçamento</a>`;
                                } else {
                                    actionBtn = `<a href="login.html" class="${btnClass}">Entrar para Enviar</a>`;
                                }
                        }

                        // --- GERAÇÃO DO HTML (USANDO CLASSES CORRETAS DO STYLE.CSS) ---
                        const cardHTML = `
                            <div class="opportunity-card" data-id="${opp.id || ''}">
                                <div class="card-header">
                                    <h3 class="card-title">${opp.title}</h3>
                                    <div class="card-icon"><i class="${opp.icon}"></i></div>
                                </div>
                                
                                ${statusBadge}
                                
                                <div class="card-school">${opp.school}</div>
                                <div class="card-location"><i class="fas fa-map-marker-alt"></i> ${opp.location}</div>
                                <p class="card-description">${opp.description}</p>
                                
                                <div class="card-footer">
                                    <span class="badge-expiry ${opp.status === 'encerrado' ? 'closed' : ''}">
                                        ${opp.status === 'encerrado' ? 'Encerrado' : 'Expira: ' + opp.expiry}
                                    </span>
                                    ${actionBtn}
                                </div>
                            </div>
                        `;
                        grid.innerHTML += cardHTML;
                    }
                });

                document.getElementById('no-results').style.display = hasItem ? 'none' : 'block';
            }

            // Event Listeners
            schoolFilter.addEventListener('change', render);
            statusFilter.addEventListener('change', render);

            // Renderiza inicial
            render();
        });
    </script>
</body>
</html>